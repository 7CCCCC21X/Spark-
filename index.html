<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>SPK Airdrop 批量查询</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --blue:#0078d4;--blue-dark:#005fa3;--bg:#f9f9f9;--card:#fff;
  --border:#e5e7eb;--text:#222;--sub:#666
}
html,body{margin:0;padding:0;height:100%}
body{
  font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;
  background:var(--bg);color:var(--text);display:flex;flex-direction:column;
  align-items:center;padding:28px 16px
}
h1{margin:0 0 24px;font-size:28px;color:var(--blue);text-align:center}

/* ---- 输入区域 ---- */
.input-wrap{
  width:100%;max-width:720px;background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:20px;box-shadow:0 3px 6px rgba(0,0,0,.05);
  display:flex;flex-direction:column;gap:12px
}
textarea{
  height:150px;resize:vertical;font-size:15px;line-height:1.4;padding:10px;
  border:1px solid var(--border);border-radius:8px;box-sizing:border-box;
  font-family:Menlo,Consolas,monospace
}
.btn{
  align-self:flex-end;background:var(--blue);color:#fff;padding:10px 28px;border:none;
  border-radius:8px;font-size:15px;cursor:pointer;transition:.18s background
}
.btn:hover{background:var(--blue-dark)} .btn:disabled{opacity:.6;cursor:not-allowed}

/* ---- 进度 ---- */
#progress{margin:14px 0;font-size:14px;color:var(--sub)}

/* ---- 表格 ---- */
table{
  width:100%;max-width:960px;border-collapse:collapse;margin-top:10px;background:var(--card);
  border-radius:10px;overflow:hidden
}
th,td{
  padding:10px 14px;border-bottom:1px solid var(--border);
  font-size:14px;text-align:left;vertical-align:top
}
th{background:#f0f4ff;font-weight:600}
tbody tr:last-child td{border-bottom:none}
small{color:var(--sub)}
.reward-col div{white-space:nowrap}
footer{margin:40px 0 10px;font-size:13px;color:var(--sub)}
a{color:var(--blue);text-decoration:none}
</style>
</head>
<body>
<h1>SPK Airdrop 批量查询</h1>

<div class="input-wrap">
  <textarea id="addrInput" placeholder="一行一个钱包地址 (0x…)"></textarea>
  <button id="queryBtn" class="btn">批量查询</button>
</div>

<div id="progress"></div>

<table style="display:none">
  <thead>
    <tr><th style="width:48px;">#</th><th style="width:190px;">地址</th><th style="width:120px;">可领取 SPK</th><th>奖励拆分</th></tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<footer>Made by <a href="https://x.com/0xXIAOc" target="_blank">@0xXIAOc</a></footer>

<script>
const input   = document.getElementById('addrInput');
const btn     = document.getElementById('queryBtn');
const tbody   = document.getElementById('resultBody');
const table   = tbody.parentElement;
const progress= document.getElementById('progress');

const fmt = n => (+n).toLocaleString(undefined,{maximumFractionDigits:4});

/* ---------- 解析 amount ---------- */
function getAmount(json){
  if(Array.isArray(json) && json.length){
    return Number(json[0]?.amount_normalized || 0);
  }
  return Number(json?.claimable ?? json?.claimable_amount ?? 0);
}

/* ---------- 奖励拆分 ---------- */
function getGroups(json){
  const arr = Array.isArray(json) ? json[0]?.groups : json?.groups;
  if(!Array.isArray(arr)) return null;
  const m = Object.fromEntries(arr.map(o=>[o.tag,o.value]));
  return {
    layer3 : m.layer3_reward   ?? 0,
    aave   : m.aave_reward     ?? 0,
    spark  : m.sparklend_reward?? 0
  };
}

btn.onclick = async () => {
  const addrs = [...new Set(
    input.value.trim().split(/\s+/).filter(a => /^0x[a-fA-F0-9]{40}$/.test(a))
  )];

  if(!addrs.length){alert('请先输入有效地址');return;}

  // 初始化
  btn.disabled = true;
  tbody.innerHTML = '';
  table.style.display = 'none';
  progress.textContent = `正在查询 0 / ${addrs.length} …`;

  let idx = 1, done = 0;
  let addrWithReward = 0, totalReward = 0;

  for(const addr of addrs){
    try{
      const res  = await fetch(
        `https://spark2-api.blockanalitica.com/api/v1/spk-airdrop/${addr}/`,
        { headers:{accept:'application/json'} }
      );
      const data = await res.json();
      const amt  = getAmount(data);
      const g    = getGroups(data);

      if(amt > 0){
        addrWithReward++;
        totalReward += amt;
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${idx++}</td>
        <td><small>${addr.slice(0,6)}…${addr.slice(-4)}</small></td>
        <td>${amt>0?fmt(amt):'—'}</td>
        <td class="reward-col" title='${JSON.stringify(data)}'>
          ${ amt>0 && g
              ? `<div>layer3: ${g.layer3}</div><div>aave&nbsp;&nbsp;: ${g.aave}</div><div>spark&nbsp;: ${g.spark}</div>`
              : '无'}
        </td>`;
      tbody.appendChild(row);

    }catch(e){
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${idx++}</td>
        <td><small>${addr.slice(0,6)}…${addr.slice(-4)}</small></td>
        <td colspan="2" style="color:#e11d48;">查询失败：${e.message}</td>`;
      tbody.appendChild(row);
    }
    progress.textContent = `正在查询 ${++done} / ${addrs.length} …`;
  }

  progress.textContent =
    `查询完成 ✔️｜总地址 ${addrs.length} ｜可领取 ${addrWithReward} ｜总量 ${fmt(totalReward)} SPK`;
  table.style.display = '';
  btn.disabled = false;
};
</script>
</body>
</html>
